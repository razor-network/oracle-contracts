version: 2.1
orbs:
  coveralls: coveralls/coveralls@1.0.6
  node: circleci/node@4.1
jobs:
  checkout_source:
    docker:
      - image: cimg/node:16.5
    steps:
      - checkout
      - persist_to_workspace:
          root: .
          paths:
            - .

  install_dependencies:
    docker:
      - image: cimg/node:16.5
    steps:
      - attach_workspace:
          at: .
      - restore_cache:
          keys:
            - dependencies-{{ checksum "package-lock.json" }}
      - run:
          name: Install dependencies
          command: npm install
      - save_cache:
          key: dependencies-{{ checksum "package-lock.json" }}
          paths:
            - node_modules
      - persist_to_workspace:
          root: .
          paths:
            - node_modules/*

  test:
    docker:
      - image: 'cimg/node:16.5'
    resource_class: large
    steps:
      - attach_workspace:
          at: .
      - run:
          name: Run tests
          command: |
            CI=true npm run test 
      - store_artifacts:
          path: test
          prefix: test


  lint:
    docker:
      - image: 'cimg/node:16.5'
    resource_class: medium
    steps:
      - attach_workspace:
          at: .
      - run:
          name: Run Lint
          command: npm run lint
      - store_artifacts:
          path: lint
          prefix: lint


  coverage:
    docker:
      - image: 'cimg/node:16.5'
    # parallelism: 10
    resource_class: xlarge
    steps:
      - attach_workspace:
          at: .
      - run:
          name: Run Coverage
          command: npm run coverage
      - coveralls/upload
      - store_artifacts:
          path: coverage
          prefix: coverage

  mythx:
    docker:
      - image: 'cimg/python:3.9.6-node'
    resource_class: medium
    steps:
      - attach_workspace:
          at: .
      - run:
          name: Setup virtual environment
          command: python -m virtualenv venv
      - run:
          name: Install MythX CLI
          command: |
            . venv/bin/activate
            pip install mythx-cli
      - run:
          name: Analyze with MythX
          command: >
            . venv/bin/activate

            mythx --ci --yes analyze --remap-import
            "@openzeppelin/=$(pwd)/node_modules/@openzeppelin/" --solc-version
            0.8.4 contracts/ --swc-blacklist 103,120

notify:
  webhooks:
    - url: >-
        https://coveralls.io/webhook?repo_token=${process.env.COVERALLS_REPO_TOKEN}
workflows:
  tests:
    jobs:
      - checkout_source
      - install_dependencies:
          requires:
            - checkout_source
      - test:
          requires:
            - install_dependencies
      - coverage:
          requires:
          - install_dependencies
      - mythx:
          requires:
          - install_dependencies
      - lint:
          requires:
          - install_dependencies
